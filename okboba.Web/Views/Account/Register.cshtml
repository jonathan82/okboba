@model okboba.Web.Models.RegisterViewModel

@{
    ViewBag.Title = "OkBoba - The Premier Dating Site for Smart Singles";
}

@using (Html.BeginForm("Register", "Account", FormMethod.Post, new { id = "registerForm" }))
{
    @Html.Partial("_RegisterStep1")
    
    @Html.Partial("_RegisterStep2")
}

@Html.Partial("_LocationPicker")


@section Scripts {

    <script>
        var positiveMessages = ["You're beautiful.","You're worth it.","Don't worry, be happy.", "You only live once."];
       
        window.history.pushState({step: 'step1'},"step1",null);

        //Next button
        $('#NextButton').click(function (e) {
            e.preventDefault();

            $('#register-step-1').fadeOut('fast', function (e) {
                $('#register-step-2').fadeIn('fast');
            });            

            window.history.pushState({step: 'step2'},null,null);
        });

        //Back button
        $(window).on('popstate', function (e) {
            //alert('popstate ' + e.originalEvent.state.step);
            if (e.originalEvent.state.step == 'step1') {
                $('#register-step-2').fadeOut('fast', function (e) {
                    $('#register-step-1').fadeIn('fast');
                });
            } else if(e.originalEvent.state.step == 'step2') {
                $('#register-step-1').fadeOut('fast', function (e) {
                    $('#register-step-2').fadeIn('fast');
                });
            }
        });

        //Setup the birthdate picker
        $("#BirthdateText").datepicker( {
            format: "yyyy年mm月",
            startView: 2, 
            minViewMode: "months",
            language: "zh-CN",
            orientation: "bottom auto",
            defaultViewDate: {year: 1980},
            startDate: '-100y',
            endDate: '-15y',
            autoclose: true
        }).on('hide', function (e) {
            //validate field
            $('#BirthdateText').valid();
        }).on('changeDate', function (e) {
            //convert chinese date to standard date - mm/dd/yyyy
            var re = /(\d\d\d\d)年(\d\d)月/;
            var match = re.exec($('#BirthdateText').val());
            if (match != null) {
                var birthdate = match[2] + '/01/' + match[1];
                $('#Birthdate').val(birthdate);
            }
        });

        //Setup the location picker
        var provinces = @Html.Raw(ViewBag.JsonProvinces);
        $('#locationText').locationpicker(provinces)
            .on('locationpicker:close', function () {
                $('#locationText').valid();
            });

        //Validation
        var validationOpts = {
            rules: {
                Gender: "required",
                LookingForGender: "required",
                Email: {
                    required: true,
                    email: true
                },
                Password: {
                    required: true,
                    minlength: 6
                },
                Nickname: {
                    required: true,
                    minlength: 2
                },
                BirthdateText: "required",
                locationText: "required"
            }
        }

        $('#registerForm').validate(validationOpts);

    </script>
}
